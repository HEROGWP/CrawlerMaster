# 新增課程爬蟲說明

## 前言

俗話說得好，「自己的學校自己寫」，若是發現自己的學校竟然沒有支援，自己幹出來並發 Pull Request 吧！我把規格都寫在這了，想幹走的就盡量拿吧！！

- <del>開源好像就能解決所有問題一樣</del>
- <del>來自一位宅宅的呼籲</del>

## 學習指南

* [Colorgy 爬蟲開發指南](爬蟲開發指南.md)
* [輕鬆鬆做個 Ruby 爬蟲機器人](http://tonytonyjan.net/slides/2014-07-03-simple-crawler/), [tonytonyjan](http://tonytonyjan.net/), 2014

## 爬蟲文件目錄

目前爬蟲相關檔案主要放在 `lib` 底下的 `course_crawler/crawlers` 資料夾。`base.rb` `mixin.rb` 兩個檔案放的是爬蟲的 helper functions，而 `crawlers.rb` 放的是爬蟲管理的 function。

```txt
lib
├── course_crawler
│   ├── base.rb
│   ├── crawlers
│   │   ├── ccu_course_crawler.rb
│   │   ├── cgu_course_crawler.rb
│   │   ├── cycu_course_crawler.rb
│   │   ├── ...
│   │   ├── ...
│   │   └── yzu_course_crawler.rb
│   ├── crawlers.rb
│   ├── mixin.rb
│   └── worker.rb
└── course_crawler.rb
```

## 新增學校課程爬蟲

放在 `course_crawler/crawlers` 資料夾底下的 `xxx_course_crawler.rb` 就是各個學校的課程爬蟲， `xxx` 為學校的英文縮寫（ruby 檔名慣例為小寫）。基本架構如下：

```ruby
# XXX 大學
# 選課網址： http://xxxxxxxx
module CourseCrawler::Crawlers
  class XxxCourseCrawler < CourseCrawler::Base
    def initialize year: current_year, term: current_term, update_progress: nil, after_each: nil, params: nil
      @year = year
      @term = term
    end

    def courses
      # code
      # ...
    end
  end
end
```

跟以前的寫法有幾點差異：

1. 包在 CourseCrawler::Crawlers module 底下
2. 繼承 CourseCrawler::Base
3. 前面加註解，太多縮寫背不起來啊哈哈

參照各爬蟲寫法完成並發送 pull request 即可。

## 資料欄位

`courses` 方法回傳的資料會是一包 `Hash` 的 `Array`（an Array of Hash），主要資料欄位如下：

* `year`：西元年 (Integer)
* `term`：學期，一般為 1 或 2 (Integer)
* `code`：課程代碼，請確認為 courses 中的唯一碼 (String)，為 `"#{year}-#{term}-#{general_code}"` 之組合
* `general_code`：通用課程代碼，請確認為 courses 中的唯一碼 (String)
* `name`：課程名稱 (String)
* `url`：課程網址（String)
* `credits`：學分數 (Integer)
* `required`：必修否 (Boolean)
* `lecturer`：教師姓名 (String)


課程節次資料

* `day_1`
* `day_2`
* `day_3`
* `day_4`
* `day_5`
* `day_6`
* `day_7`
* `day_8`
* `day_9`
* `period_1`
* `period_2`
* `period_3`
* `period_4`
* `period_5`
* `period_6`
* `period_7`
* `period_8`
* `period_9`
* `location_1`
* `location_2`
* `location_3`
* `location_4`
* `location_5`
* `location_6`
* `location_7`
* `location_8`
* `location_9`

接下來 `day_x`(Integer) `period_x`(Integer) `location_x`(String) 是為了通用課表所設計的欄位，每堂課的單一節為基本單位。

舉例來說，微積分（一）這門課在禮拜三的 3/4 節在 EE-502 這間教室上課，禮拜五的 1 節在 EE-501 這間教室上課，資料記錄如下：

```ruby
# 週三第三節
day_1 = 3
period_1 = 3
location_1 = "EE-502"

# 週三第四節
day_2 = 3
period_2 = 4
location_2 = "EE-502"

# 週五第一節
day_3 = 5
period_3 = 1
location_3 = "EE-501"
```
其餘節次欄位皆留 `nil`。[範例見此](../../blob/master/lib/course_crawler/crawlers/ntust_course_crawler.rb?ts=2#L339)。

## 開發

先把專案 clone 下來

```bash
git clone https://github.com/colorgy/CrawlerMaster
cd CrawlerMaster
```

裝需要的套件

```bash
sudo apt-get install imagemagick libmagickwand-dev
```

裝 redis (APT)

```
sudo add-apt-repository ppa:chris-lea/redis-server
sudo apt-get update
sudo apt-get install redis-server
```

裝 PG，Ubuntu 參見 [gorails](https://gorails.com/setup/ubuntu/14.04)，OS X 參見 [MDev Guides](https://github.com/MDev-tw/Guides/wiki/Mac-%E9%96%8B%E7%99%BC%E7%92%B0%E5%A2%83-%E8%A3%9D%E6%A9%9F%E6%8C%87%E5%8D%97)

後

```
bundle install
rake db:migrate
```

跑

```
rails c
```

跑起來

```ruby
[1] crawler-master(main)> courses = CourseCrawler::Crawlers::NtustCourseCrawler.new(year: 2015, term: 2).courses
```

## Setup Server

下載 [redis.conf](http://download.redis.io/redis-stable/redis.conf)，然後

```
redis-server /path/to/redis.conf # 把 redis 跑起來
bundle exec sidekiq # 跑 sidekiq
rails s # 跑 rails server
```
